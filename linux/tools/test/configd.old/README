Note: everything here is just a dirty hack and needs to be rewritten some
time in future.
